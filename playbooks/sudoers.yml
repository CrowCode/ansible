- name: Configure sudoers
  hosts: workstations:servers
  sudo: True
  tasks:


  ## Ensure sudo package is installed
  - apt: name=sudo
    when: ansible_distribution == "Debian" or ansible_distribution == "Ubuntu"

  - dnf: name=sudo
    when: ansible_distribution == "Fedora"

  - pacman: name=sudo
    when: ansible_distribution == "Archlinux" or ansible_distribution == "Manjarolinux"

  - yum: name=sudo
    when: ansible_distribution == "CentOS"


  ## Manage sudoers file
  - name: Copy sudoers file for safety
    command: cp -f /etc/sudoers /etc/sudoers.tmp

  - name: Create sudoers file backup
    command: cp -f /etc/sudoers /etc/sudoers.bak

  - name: Create admins group
    group: name=admins system=yes state=present

  - name: make sure we can sudo as admin group
    lineinfile: "dest=/etc/sudoers.tmp state=present regexp='^%admin' line='%admins ALL=(ALL) NOPASSWD: ALL'"

  - name: Final sudoers file check
    shell: visudo -q -c -f /etc/sudoers.tmp && cp -f /etc/sudoers.tmp /etc/sudoers
