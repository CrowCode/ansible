- name: create Syncthing directory
  file: path={{app_dir}}/syncthing state=directory owner=jay group=jay recurse=true
  register: syncthing_dir

- name: download syncthing
  get_url: url="{{syncthing_url}}" dest=/tmp/syncthing_{{syncthing_version}}.tar.gz
  when: syncthing_dir.changed

- name: extract syncthing
  unarchive: src=/tmp/syncthing_{{syncthing_version}}.tar.gz dest=/tmp copy=no
  when: syncthing_dir.changed

- name: install syncthing
  shell: cp /tmp/syncthing-*/syncthing {{app_dir}}/syncthing
  when: syncthing_dir.changed
  register: app_installed

- name: syncthing cleanup
  command: rm -rf /tmp/syncthing*
  when: syncthing_dir.changed

- name: copy syncthing startup script (systemd)
  copy: src=jay_systemd_syncthing dest=/etc/systemd/system/syncthing.service owner=root group=root mode=644
  when: ansible_distribution in ['Archlinux', 'CentOS', 'Debian', 'Fedora', 'Manjaro']

- name: copy syncthing startup script (sysv)
  copy: src=jay_sysv_syncthing dest=/etc/init.d/syncthing owner=root group=root mode=755
  when: ansible_distribution in ['Linuxmint']

- name: enable and start syncthing daemon
  service: name=syncthing enabled=yes state=started

- name: wait for config.xml to be generated
  wait_for: path={{syncthing_config}}

- name: config.xml | webinterface address
  lineinfile: dest={{syncthing_config}}
              regexp="<address>[^<]+</address>"
              line="        <address>0.0.0.0:8324</address>"
  notify: restart syncthing

- name: config.xml | upnpEnabled
  lineinfile: dest={{syncthing_config}}
              regexp="<upnpEnabled>[^<]+</upnpEnabled>"
              line="        <upnpEnabled>false</upnpEnabled>"
  notify: restart syncthing
